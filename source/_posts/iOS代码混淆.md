---
title: iOS代码加固
date: 2017-06-28 01:11:18
tags:
---

众所周知的是大部分iOS代码一般不会做加密加固，因为iOS APP一般是通过AppStore发布的，而且苹果的系统难以攻破，所以在iOS里做代码加固一般是一件出力不讨好的事情。万事皆有例外，不管iOS、adr还是js，加密的目的是为了代码的安全性，虽然现在开源畅行，但是不管个人开发者还是大厂皆有保护代码安全的需求，所以iOS代码加固有了生存的土壤。下面简单介绍下iOS代码加密的几种方式。

### iOS代码加密的几种方式

#### 1.字符串加密

  字符串会暴露APP的很多关键信息，攻击者可以根据从界面获取的字符串，快速找到相关逻辑的处理函数，从而进行分析破解。加密字符串可以增加攻击者阅读代码的难度以及根据字符串静态搜索的难度。   
  一般的处理方式是对需要加密的字符串加密，并保存加密后的数据，再在使用字符串的地方插入解密算法。简单的加密算法可以把NSString转为byte或者NSData的方式，还可以把字符串放到后端来返回，尽量少的暴露页面信息。下面举个简单例子，把NSString转为16进制的字符串：   

  ```
  + (NSString *)globalString {    
    return   @"5f48494748203d20323b202020202020202020202020202020202020202020202020202020202020676c6f62616c2e44495350415443485f51554555455f5052494f524954595f44454641554c54203d20303b2020202020202020202020202020202020202020202020202";  
  }
  ```
<!--more-->
#### 2.符号混淆  
  符号混淆的中心思想是将类名、方法名、变量名替换为无意义符号，提高应用安全性；防止敏感符号被class-dump工具提取，防止IDA Pro等工具反编译后分析业务代码。目前市面上的IOS应用基本上是没有使用类名方法名混淆的。  

##### a. 别名  
  在编写代码的时候直接用别名可能是最简单的一种方式，也是比较管用的一种方式。因为你的app被破解后，假如很容易就能从你的类名中寻找到蛛丝马迹，那离hook只是一步之遥，之前微信抢红包的插件应该就是用hook的方式执行的。

##### b.C重写
  编写别名的方式不是很易读，而且也不利于后续维护，这时你可能需要升级一下你的保护方式，用C来重写你的代码吧。这样把函数名隐藏在结构体中，用函数指针成员的形式存储，编译后，只留下了地址，去掉了名字和参数表，让他们无从下手(copy from 念茜)。如下例子：

  ```
  typedef struct _util {  
    BOOL (*doTrade)(void);  
    BOOL (*makeDeal)(void);  
	 void (*transferMoney)(NSString *password);  
   }FTradeUtil_t ;  

  #define FTradeUtil ([_FTradeUtil sharedUtil])  

  @interface _FTradeUtil : NSObject  

  + (FTradeUtil_t *)sharedUtil;  

  @end  

  ```

##### c.脚本处理
  稍微高级一点的是脚本扫描处理替换代码，因为要用到linux命令来编写脚本，可能会有一点门槛，不过学了之后你就可以出去吹嘘你全栈工程师的名头啦。。。
  linux脚本比较常用的几个命令如下：
  `grep  sed  awk`
  脚本混淆替换是用上述几个命令扫描出来需要替换的字符串，比如方法名，类名，变量名，并做替换，如果你能熟练应用上述几个命令，恭喜你，已经了解了脚本的一点皮毛了。  
  如以下脚本搜索遍历了代码目录下的需要混淆的关键字：  

  ```
  grep -h -r -I  "^[-+]" $ROOTFOLDER $EXCLUDE_DIR --include '*.[mh]' |sed "s/[+-]//g"|sed "s/[();,: *\^\/\{]/ /g"|sed "s/[ ]*</</"| sed "s/<.*>//g" |awk '{split($0,b," ");print b[2];}'| sort|uniq |sed "/^$/d"|sed "/^init/d" >filter_fun.txt
  ```
  替换的方式可以直接扫描文件并对文件中的所有内容替换，也可以采用define的方式定义别名。例如：

  ```
  #ifndef setIsBackgroundFetchInterval    
  #define setIsBackgroundFetchInterval setIsN0XsgPe2OVJoyuT5QWAKwaH    
  #endif // setIsBackgroundFetchInterval  
  ```

##### d.开源项目[ios-class-guard](https://github.com/Polidea/ios-class-guard)  
  该项目是基于class-dump的扩展，和脚本处理类似，是用class-dump扫描出编译后的类名、方法名、属性名等并做替换，只是不支持隐式C方法的替换，有兴趣的同学可以使用下。  

#### 2.代码逻辑混淆
  代码逻辑混淆有以下几个方面的含义：  
  对方法体进行混淆，保证源码被逆向后该部分的代码有很大的迷惑性，因为有一些垃圾代码的存在；   
  对应用程序逻辑结构进行打乱混排，保证源码可读性降到最低，这很容易把破解者带到沟里去；  
  它拥有和原始的代码一样的功能，这是最最关键的。  
  一般使用[obfuscator-llvm](https://github.com/obfuscator-llvm/obfuscator)来做代码逻辑混淆，或许会对该开源工具做个简单介绍。


#### 3.加固SDK
  adr中一般比较常见的加固等操作，iOS也有一些第三方提供这样的服务，但是没有真正使用过，不知道效果如何。   

  当然还有一些第三方服务的加固产品，基本上都是采用了以上一种或几种混淆方式做的封装，如果想要直接可以拿来使用的服务，可以采用下，常用的一些服务如下：   

  [爱加密iOS加密](http://www.ijiami.cn/ios)    
  [Safengine](http://www.safengine.com/mobile/)   
  [几维安全](http://kiwisec.com/)   

  iOS加密可能市场很小，但是存在必有道理，在越狱/开源/极客的眼中，你的APP并没有你想像的那么安全，如果希望你的代码更加安全，在闲暇的精力之外，可以小做研究，说不准你在哪天就会用到它。
